name: AI-Powered PR Assistant

# This workflow runs on pull request events to provide AI-powered assistance
on:
  pull_request:
    types: [opened, synchronize, reopened]

# Grant necessary permissions for the workflow to interact with PRs
permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  ai-pr-assistant:
    name: AI PR Analysis and Enhancement
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for better context
          
      # Step 2: Fetch PR diff and metadata
      - name: Get PR details
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Get the PR diff
            const diff = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              mediaType: {
                format: 'diff'
              }
            });
            
            // Get list of changed files
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const fileList = files.data.map(f => `${f.filename} (+${f.additions}/-${f.deletions})`).join('\n');
            
            // Store PR information
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_body', pr.body || 'No description provided');
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_author', pr.user.login);
            core.setOutput('file_list', fileList);
            core.setOutput('additions', pr.additions);
            core.setOutput('deletions', pr.deletions);
            core.setOutput('changed_files', pr.changed_files);
            
            return {
              title: pr.title,
              body: pr.body,
              files: fileList
            };
      
      # Step 3: Generate AI-powered PR summary using OpenAI
      - name: Generate AI PR Summary
        id: ai_summary
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const openaiKey = process.env.OPENAI_API_KEY;
            
            if (!openaiKey) {
              core.warning('OpenAI API key not configured. Skipping AI summary generation.');
              core.setOutput('summary', 'âš ï¸ AI summary generation skipped: OpenAI API key not configured.');
              core.setOutput('labels', '');
              core.setOutput('changelog', '');
              return;
            }
            
            const prTitle = '${{ steps.pr_details.outputs.pr_title }}';
            const prBody = '${{ steps.pr_details.outputs.pr_body }}';
            const fileList = '${{ steps.pr_details.outputs.file_list }}';
            const additions = '${{ steps.pr_details.outputs.additions }}';
            const deletions = '${{ steps.pr_details.outputs.deletions }}';
            const changedFiles = '${{ steps.pr_details.outputs.changed_files }}';
            
            // Prepare the prompt for OpenAI
            const prompt = `You are a helpful PR assistant. Analyze this pull request and provide:
            1. A concise summary (2-3 sentences)
            2. Suggested labels (comma-separated list)
            3. A changelog entry in markdown format
            
            PR Title: ${prTitle}
            PR Description: ${prBody}
            Files Changed (${changedFiles} files, +${additions}/-${deletions}):
            ${fileList}
            
            Respond in the following JSON format:
            {
              "summary": "Your summary here",
              "labels": ["label1", "label2"],
              "changelog": "- Your changelog entry here"
            }`;
            
            try {
              // Call OpenAI API
              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${openaiKey}`
                },
                body: JSON.stringify({
                  model: 'gpt-4',
                  messages: [
                    {
                      role: 'system',
                      content: 'You are a helpful GitHub PR assistant that analyzes pull requests and provides summaries, labels, and changelog entries.'
                    },
                    {
                      role: 'user',
                      content: prompt
                    }
                  ],
                  temperature: 0.7,
                  max_tokens: 500
                })
              });
              
              if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
              }
              
              const data = await response.json();
              const aiResponse = data.choices[0].message.content;
              
              // Parse the JSON response
              let parsedResponse;
              try {
                // Try to extract JSON from the response
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  parsedResponse = JSON.parse(jsonMatch[0]);
                } else {
                  throw new Error('No JSON found in response');
                }
              } catch (parseError) {
                // Fallback to plain text parsing
                parsedResponse = {
                  summary: aiResponse.split('\n')[0] || 'AI-generated summary',
                  labels: [],
                  changelog: `- ${prTitle}`
                };
              }
              
              core.setOutput('summary', parsedResponse.summary);
              core.setOutput('labels', parsedResponse.labels.join(','));
              core.setOutput('changelog', parsedResponse.changelog);
              
              console.log('AI Summary:', parsedResponse.summary);
              console.log('Suggested Labels:', parsedResponse.labels);
              console.log('Changelog Entry:', parsedResponse.changelog);
              
            } catch (error) {
              core.warning(`Failed to generate AI summary: ${error.message}`);
              core.setOutput('summary', `ðŸ“ Summary: ${prTitle}\n\nThis PR modifies ${changedFiles} file(s) with ${additions} addition(s) and ${deletions} deletion(s).`);
              core.setOutput('labels', '');
              core.setOutput('changelog', `- ${prTitle}`);
            }
      
      # Step 4: Add AI-generated comment to the PR
      - name: Post AI Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.ai_summary.outputs.summary }}`;
            const labels = `${{ steps.ai_summary.outputs.labels }}`;
            const changelog = `${{ steps.ai_summary.outputs.changelog }}`;
            const prNumber = ${{ steps.pr_details.outputs.pr_number }};
            
            // Create a formatted comment
            const commentBody = `## ðŸ¤– AI-Powered PR Assistant
            
            ### ðŸ“‹ Summary
            ${summary}
            
            ### ðŸ·ï¸ Suggested Labels
            ${labels ? labels.split(',').map(l => `\`${l.trim()}\``).join(', ') : '_No labels suggested_'}
            
            ### ðŸ“ Changelog Entry
            ${changelog || '_No changelog entry generated_'}
            
            ---
            _This comment was automatically generated by the AI PR Assistant workflow._`;
            
            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
            
            core.info('AI summary comment posted successfully!');
      
      # Step 5: Apply suggested labels (if any)
      - name: Apply Suggested Labels
        if: steps.ai_summary.outputs.labels != ''
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const labelsString = `${{ steps.ai_summary.outputs.labels }}`;
            const prNumber = ${{ steps.pr_details.outputs.pr_number }};
            
            if (!labelsString) {
              core.info('No labels to apply');
              return;
            }
            
            const labels = labelsString.split(',').map(l => l.trim()).filter(l => l);
            
            if (labels.length === 0) {
              core.info('No valid labels to apply');
              return;
            }
            
            try {
              // Get existing repository labels
              const existingLabels = await github.rest.issues.listLabelsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const existingLabelNames = existingLabels.data.map(l => l.name.toLowerCase());
              
              // Filter to only include labels that exist in the repository
              const validLabels = labels.filter(label => 
                existingLabelNames.includes(label.toLowerCase())
              );
              
              if (validLabels.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: validLabels
                });
                core.info(`Applied labels: ${validLabels.join(', ')}`);
              } else {
                core.info('No matching labels found in repository');
              }
            } catch (error) {
              core.warning(`Failed to apply labels: ${error.message}`);
            }
      
      # Step 6: Create or update changelog file (optional)
      - name: Update Changelog
        if: steps.ai_summary.outputs.changelog != ''
        continue-on-error: true
        run: |
          CHANGELOG_ENTRY="${{ steps.ai_summary.outputs.changelog }}"
          
          if [ -n "$CHANGELOG_ENTRY" ]; then
            echo "Changelog entry generated:"
            echo "$CHANGELOG_ENTRY"
            echo ""
            echo "Note: Automatic changelog updates are disabled by default."
            echo "To enable, uncomment the changelog update logic in the workflow."
          fi
