name: AI PR Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get PR diff
        id: pr-diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review
        id: ai-review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const diff = `${{ steps.pr-diff.outputs.diff }}`;
            
            // Conservative AI settings - only analyze, never auto-merge
            const systemPrompt = `You are a code review assistant. Provide constructive, concise feedback.
            Focus on:
            - Code quality and best practices
            - Potential bugs or issues
            - Security concerns
            - Performance implications
            
            Keep feedback brief and actionable. Be conservative and helpful.
            Maximum 5 key points.`;
            
            // Call OpenAI API with conservative temperature
            const https = require('https');
            const apiKey = process.env.OPENAI_API_KEY;
            
            if (!apiKey || apiKey.includes('xxx')) {
              console.log('OpenAI API key not configured. Skipping AI review.');
              core.setOutput('review', 'AI review skipped - API key not configured');
              return;
            }
            
            const data = JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: `Review this code diff:\n\n${diff.substring(0, 3000)}` }
              ],
              temperature: 0.3,
              max_tokens: 500
            });
            
            const options = {
              hostname: 'api.openai.com',
              path: '/v1/chat/completions',
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'Content-Length': data.length
              }
            };
            
            const response = await new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => body += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(body));
                  } catch (err) {
                    reject(new Error(`Failed to parse OpenAI response: ${err.message}`));
                  }
                });
              });
              req.on('error', reject);
              req.write(data);
              req.end();
            });
            
            // Validate response structure
            if (!response.choices || !response.choices.length || !response.choices[0].message) {
              throw new Error('Invalid OpenAI API response structure');
            }
            
            const review = response.choices[0].message.content;
            core.setOutput('review', review);

      - name: Post AI Review as Comment
        uses: actions/github-script@v7
        with:
          script: |
            const review = `${{ steps.ai-review.outputs.review }}`;
            
            const comment = `## ü§ñ AI Code Review (Conservative Mode)
            
            ${review}
            
            ---
            *‚ö†Ô∏è This is an AI-generated review. Human review is required.*
            *No automatic actions will be taken. Manual merge required.*
            
            **Settings:** GPT-3.5-turbo | Temperature: 0.3 | Max tokens: 500`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
